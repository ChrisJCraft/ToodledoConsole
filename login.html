using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using System.Threading.Tasks;

namespace ToodledoConsole
{
    public class TokenStorage
    {
        public string AccessToken { get; set; }
        public string RefreshToken { get; set; }
    }

    class Program
    {
        private const string AuthFile = "auth.txt";
        private const string TokenFile = "token.txt";
        private const string RedirectUri = "http://localhost:5000/";

        private static string _clientId;
        private static string _clientSecret;
        private static TokenStorage _tokens = new TokenStorage();
        private static readonly HttpClient _httpClient = new HttpClient();
        private static List<ToodledoTask> _cachedTasks = new List<ToodledoTask>();

        private static readonly JsonSerializerOptions _jsonOptions = new JsonSerializerOptions
        {
            PropertyNameCaseInsensitive = true
        };

        static async Task Main(string[] args)
        {
            Console.Clear();
            Console.WriteLine("========================================");
            Console.WriteLine("   TOODLEDO CONSOLE v1.3");
            Console.WriteLine("========================================");

            try
            {
                if (!LoadSecrets()) return;

                bool authenticated = false;
                if (File.Exists(TokenFile))
                {
                    string content = File.ReadAllText(TokenFile);
                    if (!string.IsNullOrWhiteSpace(content) && content.Trim().StartsWith("{"))
                    {
                        _tokens = JsonSerializer.Deserialize<TokenStorage>(content, _jsonOptions) ?? new TokenStorage();
                        Console.Write("Verifying session... ");
                        authenticated = await CheckConnectionAsync();

                        if (!authenticated && !string.IsNullOrEmpty(_tokens.RefreshToken))
                        {
                            Console.WriteLine("\nAccess expired. Attempting refresh...");
                            authenticated = await RefreshTokenAsync();
                        }
                    }
                }

                if (!authenticated)
                {
                    Console.WriteLine("\n[AUTH REQUIRED]");
                    Console.WriteLine("1. Open your 'login.html' file.");
                    Console.WriteLine("2. Click 'Authorize Application'.");
                    await AuthorizeAsync();
                }

                Console.WriteLine("Success! Connection Verified.");
                await RunCommandLoop();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"\n[FATAL ERROR]: {ex.Message}");
            }
        }

        private static bool LoadSecrets()
        {
            if (!File.Exists(AuthFile))
            {
                File.WriteAllLines(AuthFile, new[] { "CLIENT_ID_HERE", "CLIENT_SECRET_HERE" });
                Console.WriteLine($"Action Required: Update {AuthFile} with your API keys.");
                return false;
            }
            var lines = File.ReadAllLines(AuthFile);
            if (lines.Length < 2 || lines[0].Contains("HERE")) return false;
            _clientId = lines[0].Trim();
            _clientSecret = lines[1].Trim();
            return true;
        }

        private static async Task<bool> CheckConnectionAsync()
        {
            try
            {
                var response = await _httpClient.GetAsync($"https://api.toodledo.com/3/account/get.php?access_token={_tokens.AccessToken}");
                return response.IsSuccessStatusCode;
            }
            catch { return false; }
        }

        private static async Task<bool> RefreshTokenAsync()
        {
            var values = new Dictionary<string, string> {
                { "grant_type", "refresh_token" },
                { "refresh_token", _tokens.RefreshToken },
                { "client_id", _clientId },
                { "client_secret", _clientSecret }
            };
            var response = await _httpClient.PostAsync("https://api.toodledo.com/3/account/token.php", new FormUrlEncodedContent(values));
            if (!response.IsSuccessStatusCode) return false;

            var json = await response.Content.ReadAsStringAsync();
            var data = JsonSerializer.Deserialize<TokenResponse>(json, _jsonOptions);
            _tokens.AccessToken = data